<p style="color: green"><%= notice %></p>

<div class="retro-container">
  <button onclick="window.location.href='<%= projects_path %>'" class="btn-retro">Back to Projects</button>

  <section class="project-hero" style="margin-top:18px;">
    <div class="hero-left">
      <div class="project-media">
        <% if @project.respond_to?(:image_url) && @project.image_url.present? %>
          <img src="<%= @project.image_url %>" alt="<%= @project.name %>">
        <% elsif @project.respond_to?(:image) && @project.image.respond_to?(:attached?) && @project.image.attached? %>
          <%= image_tag(@project.image, alt: @project.name, style: "width:500px; height:300px; border-radius:5%") %>
        <% else %>
          <img style="width:500px; height:300px; border-radius:5%" src="https://placehold.co/500x300" alt="<%= @project.name %>">
        <% end %>
      </div>

      <div style="margin-top:12px">
        <h1 class="project-title"><%= @project.name %></h1>
        <div class="kv" style="margin-bottom:8px">
          <div class="label">By</div>
          <div class="value"><%= link_to @project.user.display_name, user_path(@project.user) rescue @project.user.name %></div>
        </div>
        <p class="project-desc"><%= simple_format(@project.description || 'No description provided yet. \n Required for Ship') %></p>

        <div style="margin-top:12px" class="tech-list">
          <% if @project.hackatime_ids.present? %>
            <% @project.hackatime_ids.each do |t| %>
              <span class="tech"><%= t %></span>
            <% end %>
          <% end %>
        </div>

        <div class="cta-row">
          <%= link_to 'View Repo', @project.repository_url, class: 'btn-retro', target: '_blank', rel: 'noopener' %>
          <% if @project.readme_url.present? %>
            <%= link_to 'Readme', @project.readme_url, class: 'btn-retro btn-retro--outline', target: '_blank', rel: 'noopener' %>
          <% end %>
        </div>
      </div>
    </div>

    <aside class="hero-right">
      <div class="featured-project">

        <div style="margin-top:10px; top:10px; position:relative;">
          <p><strong>Owner:</strong> <%= link_to @project.user.name, user_path(@project.user) rescue @project.user.email %></p>
          <p><strong>Total time:</strong> <%= format_duration(@project.total_seconds) %></p>
          <p><strong>Devlogged:</strong> <%= format_duration(@project.total_devlogged_seconds) %></p>
          <p><strong>Undocumented:</strong> <%= format_duration([@project.total_seconds.to_i - @project.total_devlogged_seconds, 0].max) %></p>
        </div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
          <% if @project.user == current_user %>

            <% if @project.computed_shipped? %>
              <% if @project.devlogs.where('created_at >= ?', @project.computed_shipped_at || @project.approved_at || @project.created_at).sum(:duration_minutes) >= 15 %>
                <%= button_to 'Request another ship', project_ship_requests_path(@project), method: :post, data: { confirm: 'Request a new ship?' }, class: 'btn-retro' %>
              <% else %>
                <span style="color:var(--main-700);">Add a devlog to request another ship.</span>
              <% end %>
            <% elsif @project.computed_status == 'pending' %>
              <span style="color:var(--accent2); font-weight:700">Awaiting approval</span>              <%# Link to view the pending ship request if present %>
              <% if @project.ship_requests.where(status: 'pending').exists? %>
                <%= link_to 'View request', project_ship_request_path(@project, @project.ship_requests.where(status: 'pending').first), class: 'btn-retro btn-retro--outline' %>
              <% end %>
              <%= link_to 'Ship Requests', project_ship_requests_path(@project), class: 'btn-retro btn-retro--outline', style: 'margin-left:8px' %>            <% elsif !@project.eligible_for_ship_request? %>
              <% remaining = [15 - @project.devlogged_minutes_since_baseline.to_i, 0].max %>
              <span style="font-size:1.2rem">You need <strong style="font-family:monospace;"><%= remaining %></strong> more minutes of devlogs</span>
            <% elsif @project.eligible_for_ship_request? %>
              <%= button_to 'Request Ship', ship_project_path(@project), method: :post, data: { confirm: 'Request to ship this project?' }, class: 'btn-retro' %>
            <% end %>
          <% else %>
            <%= link_to 'Back to projects', projects_path, class: 'btn-retro btn-retro--outline' %>
          <% end %>
            <%= link_to 'Edit', edit_project_path(@project), class: 'btn-retro' %>
        </div>
      </div>
    </aside>
  </section>

  <hr style="margin:24px 0">

  <div class="devlogs-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2>Devlogs</h2>
      <%= link_to "New Devlog", new_project_devlog_path(@project), class: "btn-retro" %>
    </div>

    <% if @project.devlogs.any? %>
      <%= render @project.devlogs.order(log_date: :desc) %>
    <% else %>
      <p>No devlogs yet. Document your progress!</p>
    <% end %>
  </div>

</div>
